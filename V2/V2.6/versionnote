Seems to work on various examples, probably some bugs left